<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>φ-Discovery | Integrated Physics Learning Platform</title>
    <style>
        :root {
            --bg-primary: #0a192f;
            --bg-secondary: #112240;
            --bg-tertiary: #1a2744;
            --accent-primary: #FFD700;
            --accent-secondary: #4d96ff;
            --text-primary: #e6f1ff;
            --text-secondary: #8892b0;
            --text-dim: #495670;
            --border-color: rgba(255, 215, 0, 0.1);
            --transition: all 0.25s cubic-bezier(0.645, 0.045, 0.355, 1);
            --success-color: #64ffda;
            --error-color: #ff6b6b;
            --phi: 1.618;
            
            /* Physics domain colors */
            --mechanics-color: #ff6b6b;
            --quantum-color: #4ecdc4;
            --relativity-color: #a8e6cf;
            --thermodynamics-color: #ffd93d;
            --electromagnetism-color: #95e1d3;
            --topology-color: #c7ceea;
            --golden-ratio-color: #FFD700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: "SF Mono", "Fira Code", "Consolas", monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            height: 60px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            flex-shrink: 0;
            z-index: 1000;
        }
        
        .header-logo {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mcp-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-dot.offline {
            background: var(--error-color);
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
        }
        
        .btn:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }
        
        .btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        
        /* Main Layout */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Split View */
        .split-view {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }
        
        .right-panel {
            width: 400px;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .right-panel.collapsed {
            transform: translateX(100%);
        }
        
        /* Mind Map Container */
        .mindmap-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        #mindMapCanvas {
            background: var(--bg-primary);
            cursor: grab;
            width: 100%;
            height: 100%;
        }
        
        #mindMapCanvas:active {
            cursor: grabbing;
        }
        
        /* AI Chat Interface */
        .ai-chat {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-size: 1rem;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .equation-context {
            padding: 10px 15px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: none;
        }
        
        .equation-context.active {
            display: block;
        }
        
        .context-equation {
            font-family: "Times New Roman", serif;
            font-size: 1.2rem;
            color: var(--accent-primary);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .context-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            flex-shrink: 0;
        }
        
        .message-avatar.user {
            background: var(--accent-secondary);
            color: white;
        }
        
        .message-avatar.claude {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        
        .message-content {
            flex: 1;
        }
        
        .message-author {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }
        
        .message-text {
            color: var(--text-secondary);
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .chat-input-container {
            padding: 20px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            resize: none;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        /* Betti Visual Explanations */
        .betti-explanation-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            transition: transform 0.3s ease;
        }
        
        .betti-explanation-panel.hidden {
            transform: translateY(100%);
        }
        
        .betti-visual-card {
            text-align: center;
            flex: 1;
            max-width: 250px;
        }
        
        .betti-diagram {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            position: relative;
        }
        
        .betti-value {
            font-size: 2rem;
            color: var(--accent-primary);
            font-weight: 700;
        }
        
        .betti-label {
            font-size: 0.9rem;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .betti-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* Interactive SVG Diagrams */
        .betti-svg {
            width: 100%;
            height: 100%;
        }
        
        /* Legend */
        .legend {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            max-width: 200px;
            z-index: 100;
        }
        
        .legend-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .legend-item:hover {
            color: var(--text-primary);
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* Problem Solving Mode */
        .problem-mode-banner {
            padding: 10px 20px;
            background: var(--accent-primary);
            color: var(--bg-primary);
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .problem-mode-banner.active {
            display: block;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
            max-width: 250px;
        }
        
        .tooltip.visible {
            opacity: 1;
        }
        
        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 5px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 4px;
        }
        
        .mode-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .mode-btn.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-logo">
            <span>φ-Discovery</span>
            <span style="color: var(--text-secondary); font-size: 0.8rem;">Integrated Learning Platform</span>
        </div>
        
        <div class="mcp-status">
            <div class="status-dot" id="mcpStatusDot"></div>
            <span class="status-text" id="mcpStatusText">Connecting to Claude...</span>
        </div>
        
        <div class="header-actions">
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('explore')">Explore</button>
                <button class="mode-btn" onclick="setMode('learn')">Learn</button>
                <button class="mode-btn" onclick="setMode('solve')">Solve</button>
            </div>
            <button class="btn" onclick="toggleBettiPanel()">Topology</button>
            <button class="btn" onclick="toggleAIPanel()">AI Assistant</button>
            <button class="btn" onclick="resetView()">Reset View</button>
        </div>
    </div>
    
    <div class="problem-mode-banner" id="problemModeBanner">
        Problem Solving Mode: Click equations to add them to your workspace
    </div>
    
    <div class="main-container">
        <div class="split-view">
            <div class="left-panel">
                <div class="mindmap-container">
                    <canvas id="mindMapCanvas"></canvas>
                    
                    <!-- Legend -->
                    <div class="legend" id="legend">
                        <div class="legend-title">Physics Domains</div>
                        <div id="legendItems"></div>
                    </div>
                    
                    <!-- Betti Visual Explanations -->
                    <div class="betti-explanation-panel" id="bettiPanel">
                        <div class="betti-visual-card">
                            <div class="betti-diagram">
                                <svg class="betti-svg" viewBox="0 0 80 80">
                                    <!-- B0: Connected Components -->
                                    <circle cx="20" cy="40" r="15" fill="var(--success-color)" opacity="0.3"/>
                                    <circle cx="60" cy="40" r="15" fill="var(--success-color)" opacity="0.3"/>
                                    <circle cx="20" cy="40" r="3" fill="var(--success-color)"/>
                                    <circle cx="60" cy="40" r="3" fill="var(--success-color)"/>
                                </svg>
                            </div>
                            <div class="betti-value" id="currentB0">0</div>
                            <div class="betti-label">B₀ - Components</div>
                            <div class="betti-description">
                                Number of separate, disconnected pieces in the equation's structure
                            </div>
                        </div>
                        
                        <div class="betti-visual-card">
                            <div class="betti-diagram">
                                <svg class="betti-svg" viewBox="0 0 80 80">
                                    <!-- B1: Cycles/Holes -->
                                    <circle cx="40" cy="40" r="25" fill="none" stroke="var(--success-color)" stroke-width="3"/>
                                    <circle cx="40" cy="40" r="12" fill="var(--bg-primary)"/>
                                    <path d="M 40 15 L 40 65" stroke="var(--success-color)" stroke-width="1" opacity="0.3"/>
                                    <path d="M 15 40 L 65 40" stroke="var(--success-color)" stroke-width="1" opacity="0.3"/>
                                </svg>
                            </div>
                            <div class="betti-value" id="currentB1">0</div>
                            <div class="betti-label">B₁ - Cycles</div>
                            <div class="betti-description">
                                Number of independent loops or holes in the equation's topology
                            </div>
                        </div>
                        
                        <div class="betti-visual-card">
                            <div class="betti-diagram">
                                <svg class="betti-svg" viewBox="0 0 80 80">
                                    <!-- B2: Voids/Cavities -->
                                    <ellipse cx="40" cy="40" rx="30" ry="20" fill="none" stroke="var(--success-color)" stroke-width="2" opacity="0.6"/>
                                    <ellipse cx="40" cy="40" rx="20" ry="30" fill="none" stroke="var(--success-color)" stroke-width="2" opacity="0.6"/>
                                    <circle cx="40" cy="40" r="25" fill="none" stroke="var(--success-color)" stroke-width="2"/>
                                    <circle cx="40" cy="40" r="10" fill="var(--bg-primary)" opacity="0.8"/>
                                </svg>
                            </div>
                            <div class="betti-value" id="currentB2">0</div>
                            <div class="betti-label">B₂ - Voids</div>
                            <div class="betti-description">
                                Number of enclosed 3D cavities or voids in the structure
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="right-panel" id="aiPanel">
                <div class="ai-chat">
                    <div class="chat-header">
                        <div class="chat-title">
                            <span>Claude AI Assistant</span>
                            <span style="font-size: 0.8rem; color: var(--text-secondary);">Physics Expert</span>
                        </div>
                        <button class="btn" onclick="clearChat()">Clear</button>
                    </div>
                    
                    <div class="equation-context" id="equationContext">
                        <div class="context-equation" id="contextEquation"></div>
                        <div class="context-info" id="contextInfo"></div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="message">
                            <div class="message-avatar claude">C</div>
                            <div class="message-content">
                                <div class="message-author">Claude</div>
                                <div class="message-text">Hello! I'm Claude, your AI physics assistant. I can help you:

• Understand equations and their derivations
• Solve physics problems step-by-step
• Explain topological properties (Betti numbers)
• Connect concepts across different physics domains

Click on any equation in the mind map to set the context, then ask me questions about it!</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="chat-input-wrapper">
                            <textarea 
                                class="chat-input" 
                                id="chatInput"
                                placeholder="Ask about the selected equation or any physics concept..."
                                rows="2"
                                onkeydown="handleChatKeyPress(event)"
                            ></textarea>
                            <button class="btn" onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // Enhanced equation database (reusing from previous file)
        const equationDatabase = {
            'F = ma': {
                archetype: 'mechanics',
                name: "Newton's Second Law",
                discoverer: "Isaac Newton",
                year: 1687,
                tensor: "Vector equation: F^i = m·a^i",
                units: "Force (N) = Mass (kg) × Acceleration (m/s²)",
                example: "A 2kg object accelerating at 3m/s² experiences 6N of force",
                proof: [
                    "Starting from momentum: p = mv",
                    "Force is rate of change of momentum: F = dp/dt",
                    "F = d(mv)/dt = m(dv/dt) = ma",
                    "Valid for constant mass systems"
                ],
                betti: [1, 0, 0],
                symbols: ['Force', 'Mass', 'Acceleration'],
                related: ['p = mv', 'E = ½mv²'],
                problems: [
                    "A car of mass 1000 kg accelerates from rest to 20 m/s in 5 seconds. What force is applied?",
                    "A 5 kg box is pushed with a force of 30 N. What is its acceleration?"
                ]
            },
            'E = hf': {
                archetype: 'quantum',
                name: "Planck-Einstein Relation",
                discoverer: "Max Planck & Albert Einstein",
                year: 1905,
                tensor: "Scalar: E = ℏω",
                units: "Energy (J) = Planck constant (J·s) × Frequency (Hz)",
                example: "Blue light (600THz) photon has E = 4×10⁻¹⁹J",
                proof: [
                    "Black body radiation requires quantized energy",
                    "E = nhf where n is integer (Planck)",
                    "Einstein: Light consists of photons with E = hf",
                    "Confirmed by photoelectric effect"
                ],
                betti: [1, 1, 0],
                symbols: ['Quantization', 'Photon', 'Frequency'],
                related: ['ΔxΔp ≥ ℏ/2', 'E = mc²'],
                problems: [
                    "What is the energy of a photon with wavelength 500 nm?",
                    "Calculate the frequency of a photon with energy 2.5 eV"
                ]
            },
            'E = mc²': {
                archetype: 'relativity',
                name: "Mass-Energy Equivalence",
                discoverer: "Albert Einstein",
                year: 1905,
                tensor: "E² = (pc)² + (mc²)² (full form)",
                units: "Energy (J) = Mass (kg) × Speed of light² (m²/s²)",
                example: "1kg of matter = 9×10¹⁶J (equivalent to 21.5 megatons TNT)",
                proof: [
                    "From relativistic momentum: p = γmv",
                    "Total energy: E = γmc²",
                    "At rest (v=0, γ=1): E₀ = mc²",
                    "Mass is a form of concentrated energy"
                ],
                betti: [1, 0, 1],
                symbols: ['Mass', 'Energy', 'Light Speed'],
                related: ['γ = 1/√(1-v²/c²)', 'E = hf'],
                problems: [
                    "How much energy is released when 1 gram of matter is converted to energy?",
                    "A particle has rest mass 2 GeV/c². What is its total energy at v = 0.8c?"
                ]
            },
            'φ² = φ + 1': {
                archetype: 'goldenRatio',
                name: "Golden Ratio Definition",
                discoverer: "Ancient Greeks",
                year: -300,
                tensor: "Algebraic relation",
                units: "Dimensionless (φ ≈ 1.618...)",
                example: "Rectangle with sides φ:1 - removing square leaves φ:1 rectangle",
                proof: [
                    "Definition: a/b = (a+b)/a ≡ φ",
                    "Cross multiply: a² = b(a+b)",
                    "Divide by b²: (a/b)² = (a/b) + 1",
                    "Let φ = a/b: φ² = φ + 1"
                ],
                betti: [1, 1, 1],
                symbols: ['φ', 'Recursion', 'Self-Similarity'],
                related: ['φ = (1 + √5)/2', 'F_n = (φⁿ - ψⁿ)/√5'],
                problems: [
                    "Solve the quadratic equation x² - x - 1 = 0 to find φ",
                    "Show that φ = 1 + 1/φ using the golden ratio definition"
                ]
            }
        };
        
        // Global state
        let ws = null;
        let canvas, ctx;
        let nodes = [], links = [];
        let selectedNode = null;
        let hoveredNode = null;
        let camera = { x: 0, y: 0, zoom: 1 };
        let mouse = { x: 0, y: 0, down: false, dragStart: null };
        let currentMode = 'explore';
        let equationContext = null;
        let bettiPanelVisible = false;
        let aiPanelVisible = true;
        
        // Physics domain configurations
        const archetypes = {
            mechanics: { 
                color: '#ff6b6b', 
                name: 'Mechanics',
                description: 'Classical motion and forces',
                visible: true
            },
            quantum: { 
                color: '#4ecdc4', 
                name: 'Quantum',
                description: 'Quantum mechanics and uncertainty',
                visible: true
            },
            relativity: { 
                color: '#a8e6cf', 
                name: 'Relativity',
                description: 'Space, time, and mass-energy',
                visible: true
            },
            thermodynamics: { 
                color: '#ffd93d', 
                name: 'Thermodynamics',
                description: 'Heat, entropy, and statistical mechanics',
                visible: true
            },
            electromagnetism: { 
                color: '#95e1d3', 
                name: 'Electromagnetism',
                description: 'Electric and magnetic fields',
                visible: true
            },
            topology: { 
                color: '#c7ceea', 
                name: 'Topology',
                description: 'Geometric invariants and continuity',
                visible: true
            },
            goldenRatio: { 
                color: '#FFD700', 
                name: 'Golden Ratio',
                description: 'φ and Fibonacci relationships',
                visible: true
            }
        };
        
        // Initialize on load
        window.addEventListener('load', () => {
            initializeCanvas();
            initializeNodes();
            initializeLinks();
            createLegend();
            initializeWebSocket();
            animate();
        });
        
        // Initialize canvas
        function initializeCanvas() {
            canvas = document.getElementById('mindMapCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }
        
        function resizeCanvas() {
            const container = document.querySelector('.mindmap-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            camera.x = canvas.width / 2;
            camera.y = canvas.height / 2;
        }
        
        // Initialize nodes with golden ratio positioning
        function initializeNodes() {
            const equations = Object.keys(equationDatabase);
            const archetypeGroups = {};
            
            equations.forEach(eq => {
                const data = equationDatabase[eq];
                if (!archetypeGroups[data.archetype]) {
                    archetypeGroups[data.archetype] = [];
                }
                archetypeGroups[data.archetype].push(eq);
            });
            
            let nodeId = 0;
            const centerX = camera.x;
            const centerY = camera.y;
            const baseRadius = 200;
            const PHI = 1.618;
            
            Object.keys(archetypeGroups).forEach((archetype, archetypeIndex) => {
                const equations = archetypeGroups[archetype];
                const archetypeAngle = (archetypeIndex / Object.keys(archetypeGroups).length) * Math.PI * 2;
                
                const parentX = centerX + Math.cos(archetypeAngle) * baseRadius;
                const parentY = centerY + Math.sin(archetypeAngle) * baseRadius;
                
                equations.forEach((eq, eqIndex) => {
                    const data = equationDatabase[eq];
                    const childRadius = baseRadius / PHI;
                    const childAngle = archetypeAngle + (eqIndex - equations.length/2) * 0.3;
                    
                    nodes.push({
                        id: nodeId++,
                        equation: eq,
                        archetype: archetype,
                        data: data,
                        x: parentX + Math.cos(childAngle) * childRadius,
                        y: parentY + Math.sin(childAngle) * childRadius,
                        vx: 0,
                        vy: 0,
                        radius: 35,
                        level: eqIndex === 0 ? 1 : 2,
                        visible: true
                    });
                });
            });
        }
        
        // Initialize links
        function initializeLinks() {
            nodes.forEach((node, i) => {
                const data = node.data;
                
                if (data.related) {
                    data.related.forEach(relatedEq => {
                        const targetIndex = nodes.findIndex(n => n.equation === relatedEq);
                        if (targetIndex !== -1 && targetIndex > i) {
                            links.push({
                                source: i,
                                target: targetIndex,
                                strength: 0.8,
                                type: 'related'
                            });
                        }
                    });
                }
                
                nodes.forEach((other, j) => {
                    if (i < j && node.archetype === other.archetype) {
                        links.push({
                            source: i,
                            target: j,
                            strength: 0.5,
                            type: 'archetype'
                        });
                    }
                });
            });
        }
        
        // WebSocket connection
        function initializeWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:3000/ws');
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    updateMCPStatus(true);
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateMCPStatus(false);
                };
                
                ws.onclose = () => {
                    console.log('WebSocket closed');
                    updateMCPStatus(false);
                    setTimeout(initializeWebSocket, 5000);
                };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                updateMCPStatus(false);
            }
        }
        
        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'ai_response':
                    addMessage('claude', data.response);
                    break;
                    
                case 'equation_analysis':
                    updateEquationAnalysis(data);
                    break;
                    
                case 'problem_solution':
                    displayProblemSolution(data);
                    break;
            }
        }
        
        // Update MCP status
        function updateMCPStatus(connected) {
            const dot = document.getElementById('mcpStatusDot');
            const text = document.getElementById('mcpStatusText');
            
            if (connected) {
                dot.classList.remove('offline');
                text.textContent = 'Claude Connected';
            } else {
                dot.classList.add('offline');
                text.textContent = 'Claude Offline';
            }
        }
        
        // Physics simulation
        function updatePhysics() {
            const PHI = 1.618;
            const centerForce = 0.005;
            const repelForce = 2000;
            const attractForce = 0.02;
            
            nodes.forEach((node, i) => {
                if (!node.visible) return;
                
                node.fx = 0;
                node.fy = 0;
                
                const dx = camera.x - node.x;
                const dy = camera.y - node.y;
                node.fx += dx * centerForce;
                node.fy += dy * centerForce;
                
                nodes.forEach((other, j) => {
                    if (i !== j && other.visible) {
                        const dx = node.x - other.x;
                        const dy = node.y - other.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist > 0 && dist < 300) {
                            const force = repelForce / (dist * dist);
                            node.fx += (dx / dist) * force;
                            node.fy += (dy / dist) * force;
                        }
                    }
                });
            });
            
            links.forEach(link => {
                const source = nodes[link.source];
                const target = nodes[link.target];
                
                if (!source.visible || !target.visible) return;
                
                const dx = target.x - source.x;
                const dy = target.y - source.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > 0) {
                    const idealDist = link.type === 'archetype' ? 150 : 150 * PHI;
                    const force = (dist - idealDist) * link.strength * attractForce;
                    const fx = (dx / dist) * force;
                    const fy = (dy / dist) * force;
                    
                    source.fx += fx;
                    source.fy += fy;
                    target.fx -= fx;
                    target.fy -= fy;
                }
            });
            
            nodes.forEach(node => {
                if (!node.visible) return;
                
                node.vx = (node.vx + node.fx) * 0.85;
                node.vy = (node.vy + node.fy) * 0.85;
                
                node.x += node.vx;
                node.y += node.vy;
            });
        }
        
        // Drawing function
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            ctx.translate(camera.x, camera.y);
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(-camera.x, -camera.y);
            
            // Draw links
            links.forEach(link => {
                const source = nodes[link.source];
                const target = nodes[link.target];
                
                if (!source.visible || !target.visible) return;
                
                ctx.beginPath();
                ctx.moveTo(source.x, source.y);
                ctx.lineTo(target.x, target.y);
                
                if (link.type === 'related') {
                    ctx.strokeStyle = 'rgba(255, 215, 0, 0.3)';
                    ctx.lineWidth = 2;
                } else {
                    ctx.strokeStyle = 'rgba(255, 215, 0, 0.1)';
                    ctx.lineWidth = 1;
                }
                
                ctx.stroke();
            });
            
            // Draw nodes
            nodes.forEach(node => {
                if (!node.visible) return;
                
                const archetype = archetypes[node.archetype];
                const isHovered = node === hoveredNode;
                const isSelected = node === selectedNode;
                
                if (isHovered || isSelected) {
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, node.radius + 10, 0, Math.PI * 2);
                    const gradient = ctx.createRadialGradient(
                        node.x, node.y, node.radius,
                        node.x, node.y, node.radius + 10
                    );
                    gradient.addColorStop(0, archetype.color + '40');
                    gradient.addColorStop(1, archetype.color + '00');
                    ctx.fillStyle = gradient;
                    ctx.fill();
                }
                
                ctx.beginPath();
                ctx.arc(node.x, node.y, node.radius, 0, Math.PI * 2);
                
                const gradient = ctx.createRadialGradient(
                    node.x - node.radius/3, node.y - node.radius/3, 0,
                    node.x, node.y, node.radius
                );
                gradient.addColorStop(0, archetype.color + 'FF');
                gradient.addColorStop(1, archetype.color + 'AA');
                ctx.fillStyle = gradient;
                ctx.fill();
                
                ctx.strokeStyle = isSelected ? '#FFFFFF' : archetype.color;
                ctx.lineWidth = isSelected ? 3 : 2;
                ctx.stroke();
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = `${14 * (node.level === 1 ? 1.2 : 1)}px "Times New Roman", serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(node.equation, node.x, node.y - 5);
                
                ctx.font = '10px "SF Mono", monospace';
                ctx.fillStyle = '#e6f1ff';
                ctx.fillText(node.data.name, node.x, node.y + 15);
                
                const bettiY = node.y + node.radius - 5;
                const bettiSpacing = 8;
                const bettiStartX = node.x - (node.data.betti.length - 1) * bettiSpacing / 2;
                
                node.data.betti.forEach((b, i) => {
                    ctx.beginPath();
                    ctx.arc(bettiStartX + i * bettiSpacing, bettiY, 2, 0, Math.PI * 2);
                    ctx.fillStyle = b > 0 ? '#64ffda' : '#495670';
                    ctx.fill();
                });
            });
            
            ctx.restore();
        }
        
        // Animation loop
        function animate() {
            updatePhysics();
            draw();
            requestAnimationFrame(animate);
        }
        
        // Mouse event handlers
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
            
            const worldX = (mouse.x - camera.x) / camera.zoom + camera.x;
            const worldY = (mouse.y - camera.y) / camera.zoom + camera.y;
            
            hoveredNode = null;
            nodes.forEach(node => {
                if (!node.visible) return;
                
                const dx = worldX - node.x;
                const dy = worldY - node.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < node.radius) {
                    hoveredNode = node;
                    canvas.style.cursor = 'pointer';
                    showTooltip(node, e.clientX, e.clientY);
                }
            });
            
            if (!hoveredNode) {
                canvas.style.cursor = mouse.down ? 'grabbing' : 'grab';
                hideTooltip();
            }
            
            if (mouse.down && mouse.dragStart && !selectedNode) {
                camera.x += (mouse.x - mouse.dragStart.x);
                camera.y += (mouse.y - mouse.dragStart.y);
                mouse.dragStart = { x: mouse.x, y: mouse.y };
            }
        });
        
        canvas.addEventListener('mousedown', (e) => {
            mouse.down = true;
            mouse.dragStart = { x: mouse.x, y: mouse.y };
            
            if (hoveredNode) {
                selectNode(hoveredNode);
            }
        });
        
        canvas.addEventListener('mouseup', () => {
            mouse.down = false;
            mouse.dragStart = null;
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const newZoom = Math.max(0.3, Math.min(3, camera.zoom * delta));
            
            const zoomRatio = newZoom / camera.zoom;
            camera.x = mouse.x - (mouse.x - camera.x) * zoomRatio;
            camera.y = mouse.y - (mouse.y - camera.y) * zoomRatio;
            camera.zoom = newZoom;
        });
        
        // Node selection
        function selectNode(node) {
            selectedNode = node;
            equationContext = node;
            updateEquationContext(node);
            updateBettiDisplay(node.data.betti);
            
            // Send context to AI
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'set_context',
                    equation: node.equation,
                    data: node.data
                }));
            }
        }
        
        // Update equation context display
        function updateEquationContext(node) {
            const contextDiv = document.getElementById('equationContext');
            const contextEquation = document.getElementById('contextEquation');
            const contextInfo = document.getElementById('contextInfo');
            
            contextDiv.classList.add('active');
            contextEquation.textContent = node.equation;
            contextInfo.textContent = `${node.data.name} | ${node.data.discoverer} (${node.data.year})`;
        }
        
        // Update Betti display
        function updateBettiDisplay(betti) {
            document.getElementById('currentB0').textContent = betti[0];
            document.getElementById('currentB1').textContent = betti[1];
            document.getElementById('currentB2').textContent = betti[2];
        }
        
        // Create legend
        function createLegend() {
            const legendItems = document.getElementById('legendItems');
            legendItems.innerHTML = '';
            
            Object.keys(archetypes).forEach(key => {
                const archetype = archetypes[key];
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background: ${archetype.color}"></div>
                    <span>${archetype.name}</span>
                `;
                item.onclick = () => toggleArchetype(key);
                item.title = archetype.description;
                legendItems.appendChild(item);
            });
        }
        
        // Toggle archetype visibility
        function toggleArchetype(archetypeKey) {
            archetypes[archetypeKey].visible = !archetypes[archetypeKey].visible;
            
            nodes.forEach(node => {
                if (node.archetype === archetypeKey) {
                    node.visible = archetypes[archetypeKey].visible;
                }
            });
            
            createLegend();
        }
        
        // Tooltip functions
        function showTooltip(node, x, y) {
            const tooltip = document.getElementById('tooltip');
            const data = node.data;
            tooltip.innerHTML = `
                <strong>${node.equation}</strong><br>
                ${data.name}<br>
                <span style="color: var(--accent-primary);">Click to explore</span>
            `;
            tooltip.style.left = x + 10 + 'px';
            tooltip.style.top = y - 40 + 'px';
            tooltip.classList.add('visible');
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }
        
        // Mode switching
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const banner = document.getElementById('problemModeBanner');
            if (mode === 'solve') {
                banner.classList.add('active');
            } else {
                banner.classList.remove('active');
            }
            
            if (mode === 'learn' && equationContext) {
                suggestLearningPath();
            }
        }
        
        // Toggle panels
        function toggleBettiPanel() {
            bettiPanelVisible = !bettiPanelVisible;
            const panel = document.getElementById('bettiPanel');
            if (bettiPanelVisible) {
                panel.classList.remove('hidden');
            } else {
                panel.classList.add('hidden');
            }
        }
        
        function toggleAIPanel() {
            aiPanelVisible = !aiPanelVisible;
            const panel = document.getElementById('aiPanel');
            if (aiPanelVisible) {
                panel.classList.remove('collapsed');
            } else {
                panel.classList.add('collapsed');
            }
        }
        
        // Chat functions
        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.value = '';
            addMessage('user', message);
            
            // Send to AI with context
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chat_message',
                    message: message,
                    context: equationContext ? {
                        equation: equationContext.equation,
                        data: equationContext.data
                    } : null,
                    mode: currentMode
                }));
            } else {
                addMessage('claude', 'Connection to AI assistant is not available. Please check your connection.');
            }
        }
        
        function addMessage(type, text) {
            const messagesDiv = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const avatarText = type === 'user' ? 'You' : 'C';
            const authorName = type === 'user' ? 'You' : 'Claude';
            
            messageDiv.innerHTML = `
                <div class="message-avatar ${type}">${avatarText}</div>
                <div class="message-content">
                    <div class="message-author">${authorName}</div>
                    <div class="message-text">${text}</div>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function clearChat() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';
            addMessage('claude', 'Chat cleared. How can I help you explore physics today?');
        }
        
        // Reset view
        function resetView() {
            camera.x = canvas.width / 2;
            camera.y = canvas.height / 2;
            camera.zoom = 1;
            
            Object.keys(archetypes).forEach(key => {
                archetypes[key].visible = true;
                nodes.forEach(node => {
                    if (node.archetype === key) {
                        node.visible = true;
                    }
                });
            });
            
            createLegend();
        }
        
        // Learning path suggestion
        function suggestLearningPath() {
            if (!equationContext) return;
            
            const related = equationContext.data.related || [];
            const path = `Learning path for ${equationContext.equation}:\n\n` +
                `1. Master the fundamentals of ${equationContext.data.name}\n` +
                `2. Explore related concepts: ${related.join(', ')}\n` +
                `3. Practice with provided problems\n` +
                `4. Connect to other physics domains`;
            
            addMessage('claude', path);
        }
    </script>
</body>
</html>